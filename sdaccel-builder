#!/bin/bash

set -e
set -o pipefail

export DIR
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

export ROOT_DIR="$PWD"
reco_optimize="yes"
reco_memory_protocol="smi"

function parse_yaml {
    local prefix="$2"
    local s='[[:space:]]*'
    local w='[a-zA-Z0-9_]*'
    local fs
    fs=$(echo @|tr @ '\034')
    set +e
    # shellcheck disable=SC1117
    sed -ne "s|^\($s\):|\1|" \
        -e "s|^\($s\)\($w\)$s:$s[\"']\(.*\)[\"']$s\$|\1$fs\2$fs\3|p" \
        -e "s|^\($s\)\($w\)$s:$s\(.*\)$s\$|\1$fs\2$fs\3|p"  "$1" |
        awk -F"$fs" '{
      indent = length($1)/2;
      vname[indent] = $2;
      for (i in vname) {if (i > indent) {delete vname[i]}}
      if (length($3) > 0) {
         vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
         printf("%s%s%s=\"%s\"\n", "'"$prefix"'",vn, $2, $3);
      }
   }'
   set -e
}

if [ -e 'reco.yml' ]; then
   eval "$(parse_yaml 'reco.yml' 'reco_')"
fi

function graph {
    make -e -f "$DIR/sdaccel-builder.mk" TARGET=hw OPTIMIZE="$reco_optimize" \
        MEMORY_PROTOCOL="$reco_memory_protocol" graph
}

function build {
    make -e -f "$DIR/sdaccel-builder.mk" TARGET=hw_emu OPTIMIZE="$reco_optimize" \
        MEMORY_PROTOCOL="$reco_memory_protocol" kernel sim
}

function image {
    make -e -f "$DIR/sdaccel-builder.mk" TARGET=hw OPTIMIZE="$reco_optimize" \
        MEMORY_PROTOCOL="$reco_memory_protocol" kernel
}

function test_go {
    make -e -f "$DIR/sdaccel-builder.mk" OPTIMIZE="$reco_optimize" \
        MEMORY_PROTOCOL="$reco_memory_protocol" verilog
}

function simulate {
    make -e -f "$DIR/sdaccel-builder.mk" TARGET=hw_emu OPTIMIZE="$reco_optimize" \
        MEMORY_PROTOCOL="$reco_memory_protocol" sim cmds kernel
    export PATH="$PWD/.reco-work/sdaccel/dist/":$PATH
    # This is for the emconfig.json
    cd "$PWD/.reco-work/sdaccel/dist/"

    # shellcheck source=/dev/null
    source "$XILINX_SDACCEL"/settings64.sh
    XCL_EMULATION_MODE=hw_emu XCL_BINDIR="$PWD/.reco-work/sdaccel/dist/xclbin" bash -c "$@"
}

function cmds {
    make -e -f "$DIR/sdaccel-builder.mk" cmds
}

function clean {
    make -e -f "$DIR/sdaccel-builder.mk" clean
}

function main {
    case "$1" in
        "build")
            build "${@:2}"
            ;;
        "simulate")
            simulate "${@:2}"
            ;;
        "image")
            image "${@:2}"
            ;;
        "graph")
            graph "${@:2}"
            ;;
        "cmds")
            cmds "${@:2}"
            ;;
        "test-go")
            test_go "${@:2}"
            ;;
        "clean")
            clean "${@:2}"
            ;;
        *)
            echo "unrecognized command: $1";
            exit 1
            ;;
        esac
}

main "$@"
